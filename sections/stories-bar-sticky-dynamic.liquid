<div class="stories-bar-wrapper">
  <style>
    .stories-bar {
      display:flex;
      gap:.5rem;
      justify-content:center;
      align-items:center;
      padding:.5rem 1rem;
    }
    .stories-bar-wrapper {
      position:sticky;
      top:var(--header-height,190px);
      z-index:1030;
      background:#fff;
    }
    .animated-stories-link {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .tooltip-bubble {
      opacity:0;
      position:absolute;
      top:-40px;
      left:50%;
      transform:translateX(-50%);
      background-color: {{ section.settings.tooltip_bg }};
      color:#fff;
      padding:6px 12px;
      font-size:14px;
      border-radius:4px;
      z-index:9999;
      pointer-events:none;
      transition:opacity .3s ease;
      max-width:90vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tooltip-bubble::after {
      content:"";
      position:absolute;
      top:100%;
      left:50%;
      transform:translateX(-50%);
      border:6px solid transparent;
      border-top-color: {{ section.settings.tooltip_bg }};
    }
    .tooltip-bubble.hover-visible,
    .tooltip-bubble.tap-visible {
      opacity: {{ section.settings.tooltip_opacity }};
      pointer-events:auto;
    }
    .animated-stories-link img {
      width: {{ section.settings.icon_size | plus: 0 }}px;
      height: {{ section.settings.icon_size | plus: 0 }}px;
    }
    @media (max-width:768px) {
      .animated-stories-link img {
        width: calc({{ section.settings.icon_size | plus: 0 }}px / 2);
        height: calc({{ section.settings.icon_size | plus: 0 }}px / 2);
      }
    }
  </style>

  <div class="stories-bar">
    {% assign lang = request.locale.iso_code %}
    {% case lang %}
      {% when 'fr' %}{% assign base_url = '/fr/collections/' %}
      {% when 'de' %}{% assign base_url = '/de/collections/' %}
      {% else %}{% assign base_url = '/collections/' %}
    {% endcase %}

    {% for block in section.blocks %}
      {% assign title = block.settings.title | strip %}
      {% assign image_obj = block.settings.image %}
      {% assign raw_link = block.settings.link | strip %}
      {% assign href = raw_link %}

      {% if href == blank %}
        {% assign href = base_url | append: title | handleize %}
      {% else %}
        {%- assign first_char = href | slice: 0, 1 -%}
        {% unless href contains '://' or first_char == '/' %}
          {% assign href = base_url | append: href %}
        {% endunless %}
      {% endif %}

      {% assign tip_id = 'tip-' | append: block.id %}

      <a href="{{ href }}" class="animated-stories-link" aria-describedby="{{ tip_id }}" aria-label="{{ title | escape }}">
        {% if image_obj %}
          <img
            src="{{ image_obj | image_url: width: 360 }}"
            srcset="{{ image_obj | image_url: width: 180 }} 180w, {{ image_obj | image_url: width: 360 }} 360w, {{ image_obj | image_url: width: 720 }} 720w"
            sizes="(max-width:768px) {{ section.settings.icon_size | plus: 0 | divided_by: 2 }}px, {{ section.settings.icon_size | plus: 0 }}px"
            alt="{{ title | escape }}"
            loading="lazy"
            decoding="async">
        {% endif %}
        <div class="tooltip-bubble" role="tooltip" id="{{ tip_id }}">{{ title | escape }}</div>
      </a>
    {% endfor %}
  </div>
</div>

{% schema %}
{
  "name": "Stories Bar Sticky",
  "settings": [
    {
      "type": "select",
      "id": "icon_size",
      "label": "Taille des icônes (px)",
      "default": "90",
      "options": [
        { "value": "60", "label": "60px" },
        { "value": "90", "label": "90px" },
        { "value": "120", "label": "120px" }
      ]
    },
    {
      "type": "color",
      "id": "tooltip_bg",
      "label": "Couleur de fond de l'infobulle",
      "default": "#0F6378"
    },
    {
      "type": "range",
      "id": "tooltip_opacity",
      "label": "Opacité de l'infobulle",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 1
    }
  ],
  "blocks": [
    {
      "type": "story",
      "name": "Story",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Nom de la collection",
          "default": "SPA"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Icône"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Lien vers la collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Stories Bar Sticky",
      "blocks": []
    }
  ]
}
{% endschema %}