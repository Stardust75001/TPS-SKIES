{% liquid
  assign pt = section.settings.pt | prepend: 'pt-'
  assign pb = section.settings.pb | prepend: 'pb-'
  assign mt = section.settings.mt | prepend: 'mt-'
  assign mb = section.settings.mb | prepend: 'mb-'

  assign url = section.settings.video_url | default: ''

  assign is_youtube = false
  assign is_vimeo = false
  if url != ''
    if url contains 'youtube'
      assign is_youtube = true
    elsif url contains 'vimeo'
      assign is_vimeo = true
    endif
  endif

  assign has_embed = false
  if url != ''
    if is_youtube or is_vimeo
      assign has_embed = true
    endif
  endif
%}

<section id="video-hero-{{ section.id }}" class="video-hero {{ section.settings.bg_color }} {{ pt }} {{ pb }} {{ mt }} {{ mb }}">
  <div class="video-hero-wrapper position-relative">

    <!-- Fond (image LCP prioritaire + mÃ©dias lazy) -->
    <div class="video-container" aria-hidden="true" style="position:absolute;inset:0;z-index:1;">
      {% if section.settings.image != blank %}
        {% assign img = section.settings.image %}
        <img
          src="{{ img | image_url: width: 1600, format: 'webp' }}"
          srcset="
            {{ img | image_url: width: 640,  format: 'webp' }} 640w,
            {{ img | image_url: width: 960,  format: 'webp' }} 960w,
            {{ img | image_url: width: 1280, format: 'webp' }} 1280w,
            {{ img | image_url: width: 1600, format: 'webp' }} 1600w
          "
          sizes="100vw"
          alt="{{ img.alt | escape }}"
          width="1600"
          height="{{ 1600 | divided_by: img.aspect_ratio | round }}"
          loading="eager"
          fetchpriority="high"
          decoding="async"
          style="width:100%;height:100%;object-fit:cover;object-position:center"
        >
      {% endif %}

      {% if section.settings.video_hosted != blank %}
        <video
          class="vh-video is-lazy w-100 h-100"
          muted playsinline loop preload="none"
          poster="{{ section.settings.video_poster | default: section.settings.image | image_url: width: 1200 }}"
          data-src="{{ section.settings.video_hosted }}"
          style="object-fit:cover;object-position:center;display:none"
        ></video>
      {% endif %}

      {% if has_embed %}
        <div
          class="vh-iframe is-lazy w-100 h-100"
          data-src="{% if is_youtube %}https://www.youtube.com/embed/{{ url | split: 'v=' | last | split: '&' | first }}?autoplay=1&mute=1&loop=1&playlist={{ url | split: 'v=' | last | split: '&' | first }}&controls=0&rel=0&modestbranding=1{% else %}https://player.vimeo.com/video/{{ url | split: '/' | last }}?autoplay=1&muted=1&loop=1&background=1&controls=0{% endif %}"
          role="presentation"
          style="position:absolute;inset:0;display:none"
        ></div>
      {% endif %}
    </div>

    {% if section.settings.overlay_opacity > 0 %}
      <div class="video-overlay" style="position:absolute;inset:0;z-index:2;background:rgba(0,0,0,{{ section.settings.overlay_opacity | divided_by: 100.0 }});"></div>
    {% endif %}

    <div class="video-content position-absolute w-100 h-100 d-flex align-items-center" style="z-index:3;">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            {% unless section.settings.heading == blank %}
              <h1 class="video-hero-title {{ section.settings.heading_size }} {{ section.settings.text_color }} mb-4">
                {{ section.settings.heading }}
              </h1>
            {% endunless %}
            {% unless section.settings.subheading == blank %}
              <p class="video-hero-subtitle {{ section.settings.subheading_size }} {{ section.settings.text_color }} mb-5">
                {{ section.settings.subheading }}
              </p>
            {% endunless %}
            {% unless section.settings.button_text == blank %}
              <a href="{{ section.settings.button_link | default: '#' }}" class="btn {{ section.settings.button_style }} {{ section.settings.button_size }}">
                {{ section.settings.button_text }}
              </a>
            {% endunless %}
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<style>
  #video-hero-{{ section.id }}{height:{{ section.settings.section_height }}vh;overflow:hidden}
  @media (max-width:768px){#video-hero-{{ section.id }}{height:{{ section.settings.section_height_mobile }}vh}}
  .video-hero-title{animation:fadeInUp 1s ease-out}
  .video-hero-subtitle{animation:fadeInUp 1s ease-out .3s both}
  .video-hero .btn{animation:fadeInUp 1s ease-out .6s both}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
</style>

<script>
  // Lazy inject hosted video / iframe only when visible
  (function(){
    var root = document.getElementById('video-hero-{{ section.id }}');
    if(!root || !('IntersectionObserver' in window)) return;

    var show = function(el){ el.style.display=''; };

    var io = new IntersectionObserver(function(entries){
      entries.forEach(function(entry){
        if(!entry.isIntersecting) return;

        var v = root.querySelector('.vh-video.is-lazy');
        if (v && v.dataset.src && !v.src) {
          v.src = v.dataset.src;
          v.load();
          v.play && v.play().catch(function(){});
          show(v);
        }

        var i = root.querySelector('.vh-iframe.is-lazy');
        if (i && i.dataset.src && !i.firstChild) {
          var iframe = document.createElement('iframe');
          iframe.className = 'video-hero-video w-100 h-100';
          iframe.allow = 'autoplay; encrypted-media; fullscreen; picture-in-picture';
          iframe.frameBorder = '0';
          iframe.src = i.dataset.src;
          i.appendChild(iframe);
          show(i);
        }

        io.disconnect();
      });
    }, { rootMargin: '200px' });

    io.observe(root);
  })();
</script>

{% schema %}
{
  "name": "Video Hero",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Video Hero Section" },
    { "type": "select", "id": "heading_size", "label": "Heading Size",
      "options": [
        { "value": "h1", "label": "H1" }, { "value": "h2", "label": "H2" }, { "value": "h3", "label": "H3" },
        { "value": "display-1", "label": "Display 1" }, { "value": "display-2", "label": "Display 2" }
      ],
      "default": "display-1"
    },
    { "type": "textarea", "id": "subheading", "label": "Subheading",
      "default": "Create an immersive experience with video backgrounds"
    },
    { "type": "select", "id": "subheading_size", "label": "Subheading Size",
      "options": [
        { "value": "fs-6", "label": "Small" }, { "value": "fs-5", "label": "Medium" },
        { "value": "fs-4", "label": "Large" }, { "value": "fs-3", "label": "Extra Large" }
      ],
      "default": "fs-5"
    },
    { "type": "text", "id": "button_text", "label": "Button Text", "default": "Shop Now" },
    { "type": "url", "id": "button_link", "label": "Button Link" },
    { "type": "select", "id": "button_style", "label": "Button Style",
      "options": [
        { "value": "btn-primary", "label": "Primary" }, { "value": "btn-secondary", "label": "Secondary" },
        { "value": "btn-outline-primary", "label": "Outline Primary" },
        { "value": "btn-outline-secondary", "label": "Outline Secondary" },
        { "value": "btn-outline-light", "label": "Outline Light" }
      ],
      "default": "btn-primary"
    },
    { "type": "select", "id": "button_size", "label": "Button Size",
      "options": [ { "value": "btn-sm", "label": "Small" }, { "value": "", "label": "Medium" }, { "value": "btn-lg", "label": "Large" } ],
      "default": "btn-lg"
    },
    { "type": "image_picker", "id": "image", "label": "LCP image (poster / fallback)" },
    { "type": "video", "id": "video_hosted", "label": "Hosted Video (MP4)" },
    { "type": "text", "id": "video_url", "label": "YouTube/Vimeo URL" },
    { "type": "image_picker", "id": "video_poster", "label": "Video Poster Image" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay Opacity", "min": 0, "max": 90, "step": 10, "default": 30, "unit": "%" },
    { "type": "select", "id": "text_color", "label": "Text Color",
      "options": [
        { "value": "text-white", "label": "White" }, { "value": "text-dark", "label": "Dark" },
        { "value": "text-primary", "label": "Primary" }, { "value": "text-secondary", "label": "Secondary" }
      ],
      "default": "text-white"
    },
    { "type": "range", "id": "section_height", "label": "Section Height", "min": 50, "max": 100, "step": 5, "default": 100, "unit": "vh" },
    { "type": "range", "id": "section_height_mobile", "label": "Section Height (Mobile)", "min": 40, "max": 100, "step": 5, "default": 70, "unit": "vh" },
    { "type": "select", "id": "bg_color", "label": "Background Color",
      "options": [ { "value": "", "label": "None" }, { "value": "bg-light", "label": "Light" }, { "value": "bg-dark", "label": "Dark" }, { "value": "bg-primary", "label": "Primary" } ],
      "default": ""
    },
    { "type": "range", "id": "pt", "label": "Padding Top", "min": 0, "max": 10, "step": 1, "default": 0 },
    { "type": "range", "id": "pb", "label": "Padding Bottom", "min": 0, "max": 10, "step": 1, "default": 0 },
    { "type": "range", "id": "mt", "label": "Margin Top", "min": 0, "max": 10, "step": 1, "default": 0 },
    { "type": "range", "id": "mb", "label": "Margin Bottom", "min": 0, "max": 10, "step": 1, "default": 0 }
  ],
  "presets": [ { "name": "Video Hero" } ]
}
{% endschema %}